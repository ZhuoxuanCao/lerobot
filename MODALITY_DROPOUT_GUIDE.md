# æ¨¡æ€ä¸¢å¼ƒï¼ˆModality Dropoutï¼‰ä½¿ç”¨æŒ‡å—

## âœ… å®æ–½å®Œæˆ

æ¨¡æ€ä¸¢å¼ƒåŠŸèƒ½å·²æˆåŠŸé›†æˆåˆ°ACTç­–ç•¥ä¸­ã€‚æ‰€æœ‰é™æ€ä»£ç æ£€æŸ¥é€šè¿‡ï¼

## ğŸ“‹ ä¿®æ”¹æ‘˜è¦

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`src/lerobot/policies/act/configuration_act.py`**
   - æ·»åŠ äº† `use_modality_dropout: bool = False`ï¼ˆé»˜è®¤å…³é—­ï¼‰
   - æ·»åŠ äº† `modality_dropout_prob: float = 0.3`ï¼ˆ30%æ¦‚ç‡ï¼‰
   - åŒ…å«è¯¦ç»†çš„docstringè¯´æ˜

2. **`src/lerobot/policies/act/modeling_act.py`**
   - åœ¨ `ACTPolicy.forward` æ–¹æ³•å¼€å¤´æ·»åŠ äº†æ¨¡æ€ä¸¢å¼ƒé€»è¾‘
   - åŒ…æ‹¬é˜²å¾¡æ€§æ£€æŸ¥ï¼šé…ç½®å¼€å…³ã€è®­ç»ƒæ¨¡å¼ã€keyå­˜åœ¨æ€§
   - åœ¨è®­ç»ƒæ—¶éšæœºå°† `batch[OBS_STATE]` ç½®é›¶

### æ–°å¢çš„æµ‹è¯•æ–‡ä»¶

1. **`test_modality_dropout.py`** - å®Œæ•´åŠŸèƒ½æµ‹è¯•ï¼ˆéœ€è¦å®Œæ•´ç¯å¢ƒï¼‰
2. **`test_modality_dropout_simple.py`** - é™æ€ä»£ç éªŒè¯ï¼ˆå·²é€šè¿‡âœ…ï¼‰

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šåŸå§‹è®­ç»ƒï¼ˆé»˜è®¤è¡Œä¸ºï¼Œæ— ä»»ä½•æ”¹å˜ï¼‰

```bash
lerobot-train \
  --dataset.repo_id="cao/so101_stack_green_on_bottom_v6" \
  --policy.type=act \
  --batch_size=16 \
  --steps=15000 \
  --output_dir=outputs/baseline_no_dropout
```

**ç‰¹æ€§ï¼š**
- âœ… ä¸ä¿®æ”¹å‰è¡Œä¸º100%ä¸€è‡´
- âœ… æ— æ€§èƒ½å¼€é”€
- âœ… æ— éœ€ä»»ä½•é…ç½®æ›´æ”¹

---

### æ–¹æ³•2ï¼šå¯ç”¨æ¨¡æ€ä¸¢å¼ƒï¼ˆæ¨èé…ç½®ï¼‰

```bash
lerobot-train \
  --dataset.repo_id="cao/so101_stack_green_on_bottom_v6" \
  --policy.type=act \
  --policy.use_modality_dropout=true \
  --policy.modality_dropout_prob=0.3 \
  --batch_size=16 \
  --steps=15000 \
  --output_dir=outputs/modality_dropout_p03 \
  --wandb.project=SO101_modality_dropout \
  --wandb.run_name=dropout_p0.3
```

**ç‰¹æ€§ï¼š**
- ğŸ¯ 30%çš„è®­ç»ƒbatchå°†çŠ¶æ€ç½®é›¶
- ğŸ¯ å¼ºåˆ¶æ¨¡å‹ä¾èµ–è§†è§‰ä¿¡æ¯
- ğŸ¯ æ¨ç†æ—¶çŠ¶æ€æ­£å¸¸å¯ç”¨ï¼ˆä¸å½±å“éƒ¨ç½²ï¼‰

---

### æ–¹æ³•3ï¼šä¿å®ˆæµ‹è¯•ï¼ˆé™ä½æ¦‚ç‡ï¼‰

```bash
lerobot-train \
  --dataset.repo_id="cao/so101_stack_green_on_bottom_v6" \
  --policy.type=act \
  --policy.use_modality_dropout=true \
  --policy.modality_dropout_prob=0.2 \
  --batch_size=16 \
  --steps=15000 \
  --output_dir=outputs/modality_dropout_p02
```

**é€‚ç”¨åœºæ™¯ï¼š**
- æ‹…å¿ƒè¿‡åº¦å‰Šå¼±çŠ¶æ€ä¿¡æ¯
- ä»»åŠ¡éœ€è¦è¾ƒå¤šæœ¬ä½“æ„Ÿå®˜åé¦ˆï¼ˆå¦‚åŠ›æ§ï¼‰
- ç¬¬ä¸€æ¬¡å°è¯•è¯¥æŠ€æœ¯

---

### æ–¹æ³•4ï¼šæ¿€è¿›æµ‹è¯•ï¼ˆæé«˜æ¦‚ç‡ï¼‰

```bash
lerobot-train \
  --dataset.repo_id="cao/so101_stack_green_on_bottom_v6" \
  --policy.type=act \
  --policy.use_modality_dropout=true \
  --policy.modality_dropout_prob=0.4 \
  --batch_size=16 \
  --steps=15000 \
  --output_dir=outputs/modality_dropout_p04
```

**é€‚ç”¨åœºæ™¯ï¼š**
- p=0.3æ•ˆæœä¸æ˜æ˜¾
- ç¡®è®¤ä»»åŠ¡ä¸»è¦ä¾èµ–è§†è§‰
- æ¢ç´¢æœ€å¤§æ½œåŠ›

---

## ğŸ“Š å»ºè®®çš„å®éªŒæ–¹æ¡ˆ

### Phase 1: å¿«é€ŸéªŒè¯ï¼ˆ1å¤©ï¼‰

**ç›®æ ‡ï¼š**éªŒè¯è®­ç»ƒç¨³å®šæ€§ï¼Œæ— å´©æºƒ

```bash
# çŸ­è®­ç»ƒæµ‹è¯•ï¼ˆ100 stepsï¼‰
lerobot-train \
  --dataset.repo_id="cao/so101_stack_green_on_bottom_v6" \
  --policy.type=act \
  --policy.use_modality_dropout=true \
  --policy.modality_dropout_prob=0.3 \
  --batch_size=8 \
  --steps=100 \
  --output_dir=/tmp/test_dropout_stability
```

**æ£€æŸ¥ç‚¹ï¼š**
- âœ… è®­ç»ƒæ— æŠ¥é”™
- âœ… Lossæ•°å€¼æ­£å¸¸ï¼ˆä¸æ˜¯NaNæˆ–Infï¼‰
- âœ… æ—¥å¿—æ˜¾ç¤ºæ­£å¸¸ï¼ˆæ— å¼‚å¸¸è­¦å‘Šï¼‰

---

### Phase 2: å¯¹æ¯”å®éªŒï¼ˆ2-3å¤©ï¼‰

**ç›®æ ‡ï¼š**é‡åŒ–æ¨¡æ€ä¸¢å¼ƒçš„æ•ˆæœ

**å®éªŒç»„è®¾è®¡ï¼š**

| å®éªŒç»„ | use_modality_dropout | modality_dropout_prob | è¾“å‡ºç›®å½• |
|--------|---------------------|----------------------|---------|
| Baseline | false | - | outputs/baseline |
| Dropout-20% | true | 0.2 | outputs/dropout_p02 |
| Dropout-30% | true | 0.3 | outputs/dropout_p03 |
| Dropout-40% | true | 0.4 | outputs/dropout_p04 |

**å¹¶è¡Œè¿è¡Œå‘½ä»¤ï¼š**

```bash
# Baseline
lerobot-train --policy.type=act --steps=15000 \
  --output_dir=outputs/baseline &

# p=0.2
lerobot-train --policy.type=act --steps=15000 \
  --policy.use_modality_dropout=true \
  --policy.modality_dropout_prob=0.2 \
  --output_dir=outputs/dropout_p02 &

# p=0.3ï¼ˆæ¨èï¼‰
lerobot-train --policy.type=act --steps=15000 \
  --policy.use_modality_dropout=true \
  --policy.modality_dropout_prob=0.3 \
  --output_dir=outputs/dropout_p03 &

# p=0.4
lerobot-train --policy.type=act --steps=15000 \
  --policy.use_modality_dropout=true \
  --policy.modality_dropout_prob=0.4 \
  --output_dir=outputs/dropout_p04 &

wait
```

**è¯„ä¼°æŒ‡æ ‡ï¼š**

| æŒ‡æ ‡ | æœŸæœ›å˜åŒ– | è·å–æ–¹å¼ |
|------|---------|---------|
| train/l1_loss | åœ¨baselineçš„Â±10%å†… | WandBè‡ªåŠ¨è®°å½• |
| eval/success_rate | +8-15% | è¯„ä¼°è„šæœ¬ |
| è§†è§‰æ³¨æ„åŠ›å æ¯”* | 25% â†’ 40-50% | éœ€è¦å¯è§†åŒ–è„šæœ¬ |
| æ”¾ç½®ç²¾åº¦ | åå·®å‡å°‘ | æœºå™¨äººå®æµ‹ |

*æ³¨ï¼šè§†è§‰æ³¨æ„åŠ›å æ¯”éœ€è¦åœ¨Phase 3å®ç°æ³¨æ„åŠ›å¯è§†åŒ–

---

### Phase 3: æœºå™¨äººå®æµ‹ï¼ˆ1å¤©ï¼‰

**æµ‹è¯•åè®®ï¼š**

1. **å›ºå®šä½ç½®æµ‹è¯•**ï¼ˆ20æ¬¡ï¼‰
   - ç‰©ä½“æ”¾ç½®åœ¨ç›¸åŒä½ç½®
   - è®°å½•æˆåŠŸç‡ã€å¹³å‡è¯¯å·®ã€æœ€å¤§è¯¯å·®

2. **éšæœºä½ç½®æµ‹è¯•**ï¼ˆ20æ¬¡ï¼‰
   - ç‰©ä½“åœ¨Â±5cmèŒƒå›´å†…éšæœºæ”¾ç½®
   - éªŒè¯æ³›åŒ–èƒ½åŠ›

**å¯¹æ¯”æ¨¡å‹ï¼š**
- Baselineï¼ˆæ— dropoutï¼‰
- Dropout p=0.3ï¼ˆæ¨èé…ç½®ï¼‰

---

## ğŸ”„ å›é€€æ–¹æ¡ˆ

å¦‚æœæ•ˆæœä¸å¥½ï¼Œå¯ä»¥ç«‹å³å›é€€ï¼š

### æ–¹æ³•Aï¼šä¿®æ”¹é…ç½®æ–‡ä»¶

```yaml
# config.yaml
policy:
  type: act
  use_modality_dropout: false  # æ”¹ä¸ºfalse
```

### æ–¹æ³•Bï¼šå‘½ä»¤è¡Œè¦†ç›–

```bash
lerobot-train \
  --config=outputs/dropout_p03/config.yaml \
  --policy.use_modality_dropout=false  # å¼ºåˆ¶å…³é—­
```

### æ–¹æ³•Cï¼šä»checkpointæ¢å¤

```bash
# åŠ è½½dropoutè®­ç»ƒçš„æƒé‡ï¼Œä½†å…³é—­dropoutç»§ç»­è®­ç»ƒ
lerobot-train \
  --resume_from=outputs/dropout_p03/checkpoint-5000 \
  --policy.use_modality_dropout=false
```

**å…³é”®ï¼š**æƒé‡å®Œå…¨å…¼å®¹ï¼ˆæœªæ”¹æ¨¡å‹ç»“æ„ï¼‰ï¼Œå¯è‡ªç”±åˆ‡æ¢ã€‚

---

## âš™ï¸ é…ç½®å‚æ•°è¯¦è§£

### `use_modality_dropout`

**ç±»å‹ï¼š** `bool`
**é»˜è®¤å€¼ï¼š** `False`
**å«ä¹‰ï¼š** æ˜¯å¦å¯ç”¨æ¨¡æ€ä¸¢å¼ƒ

**è¡Œä¸ºï¼š**
- `False`ï¼šå®Œå…¨å…³é—­ï¼Œè¡Œä¸ºä¸åŸå§‹ä»£ç ä¸€è‡´
- `True`ï¼šå¯ç”¨ï¼ŒæŒ‰æ¦‚ç‡éšæœºä¸¢å¼ƒçŠ¶æ€

---

### `modality_dropout_prob`

**ç±»å‹ï¼š** `float`
**é»˜è®¤å€¼ï¼š** `0.3`
**èŒƒå›´ï¼š** `0.0 - 1.0`ï¼ˆæ¨è `0.2 - 0.4`ï¼‰

**å«ä¹‰ï¼š** è®­ç»ƒæ—¶ä¸¢å¼ƒçŠ¶æ€çš„æ¦‚ç‡

**é€‰æ‹©æŒ‡å—ï¼š**

| æ¦‚ç‡ | é€‚ç”¨åœºæ™¯ | é¢„æœŸæ•ˆæœ |
|------|---------|---------|
| 0.2 | ä¿å®ˆæµ‹è¯•ï¼Œä»»åŠ¡éœ€è¦çŠ¶æ€åé¦ˆ | æ¸©å’Œæå‡è§†è§‰ä¾èµ– |
| 0.3 | **æ¨èå€¼**ï¼Œå¹³è¡¡è§†è§‰å’ŒçŠ¶æ€ | æ˜¾è‘—æå‡è§†è§‰ä¾èµ– |
| 0.4 | æ¿€è¿›æµ‹è¯•ï¼Œä»»åŠ¡çº¯è§†è§‰ä¸»å¯¼ | æœ€å¤§åŒ–è§†è§‰ä¾èµ– |
| 0.5+ | æç«¯æµ‹è¯•ï¼ˆä¸æ¨èï¼‰ | å¯èƒ½æŸå®³æ€§èƒ½ |

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### å®šé‡æŒ‡æ ‡

| æŒ‡æ ‡ | Baseline | é¢„æœŸï¼ˆp=0.3ï¼‰ | æå‡å¹…åº¦ |
|------|----------|-------------|---------|
| è§†è§‰æ³¨æ„åŠ›å æ¯” | ~25% | 40-50% | +15-25% |
| ä»»åŠ¡æˆåŠŸç‡ | 20% | 28-35% | +8-15% |
| ç»¿è‰²æ–¹å—æ”¾ç½®åå·® | 3-5cm | 2-3cm | æ”¹å–„ |
| è“è‰²æ–¹å—æŠ“å–æˆåŠŸç‡ | 40% | 50-55% | +10-15% |

### å®šæ€§æ•ˆæœ

**æœŸæœ›è¡Œä¸ºå˜åŒ–ï¼š**
- âœ… æ¨¡å‹æ›´ä¸»åŠ¨åœ°ä½¿ç”¨ç›¸æœºä¿¡æ¯å®šä½ç‰©ä½“
- âœ… ç³»ç»Ÿæ€§æ”¾ç½®åå·®å‡å°‘æˆ–æ¶ˆé™¤
- âœ… å¯¹ç‰©ä½“ä½ç½®å˜åŒ–çš„é²æ£’æ€§æå‡
- âœ… å…‰ç…§å˜åŒ–ä¸‹çš„æ€§èƒ½æå‡

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šè®­ç»ƒLosså‘æ•£

**ç—‡çŠ¶ï¼š**
```
step 100: l1_loss = 0.05
step 500: l1_loss = 0.12
step 1000: l1_loss = 0.35  # ä¸æ–­ä¸Šå‡
```

**åŸå› ï¼š**dropoutæ¦‚ç‡è¿‡é«˜ï¼Œæ¨¡å‹æ— æ³•æ”¶æ•›

**è§£å†³ï¼š**
```bash
# é™ä½æ¦‚ç‡
--policy.modality_dropout_prob=0.2
```

---

### é—®é¢˜2ï¼šLosså‡ºç°NaN

**ç—‡çŠ¶ï¼š**
```
step 523: l1_loss = nan
```

**åŸå› ï¼š**æå°‘æ•°æƒ…å†µä¸‹ï¼Œæ•°å€¼ä¸ç¨³å®š

**è§£å†³ï¼š**
1. æ£€æŸ¥æ•°æ®é›†æ˜¯å¦æœ‰å¼‚å¸¸å€¼
2. é™ä½å­¦ä¹ ç‡
3. æ£€æŸ¥æ¢¯åº¦è£å‰ªé…ç½®

**æ³¨ï¼š**æ¨¡æ€ä¸¢å¼ƒæœ¬èº«ä¸åº”å¯¼è‡´NaNï¼ˆå·²é€šè¿‡å®‰å…¨æ€§åˆ†æï¼‰

---

### é—®é¢˜3ï¼šæ•ˆæœä¸æ˜æ˜¾

**ç—‡çŠ¶ï¼š**
- è®­ç»ƒæ­£å¸¸
- ä½†æˆåŠŸç‡æå‡<5%

**åŸå› ï¼š**
- æ¦‚ç‡å¯èƒ½è¿‡ä½
- æˆ–è€…ä»»åŠ¡æœ¬èº«ä¸æ˜¯"æ·å¾„å­¦ä¹ "é—®é¢˜

**è¯Šæ–­ï¼š**
```bash
# å°è¯•æé«˜æ¦‚ç‡
--policy.modality_dropout_prob=0.4

# æˆ–è€…ç»„åˆå…¶ä»–æ–¹æ³•ï¼ˆPhase 2ï¼‰
# æ·»åŠ æ³¨æ„åŠ›æ­£åˆ™åŒ–æŸå¤±
```

---

## ğŸ“š æŠ€æœ¯åŸç†

### ä¸ºä»€ä¹ˆæ¨¡æ€ä¸¢å¼ƒæœ‰æ•ˆï¼Ÿ

**é—®é¢˜æ ¹æºï¼š**
```python
# æ¨¡å‹å­¦åˆ°çš„æ·å¾„è§„åˆ™ï¼ˆé”™è¯¯ï¼‰
if shoulder_angle == -30Â°:
    gripper.open()  # åœ¨å›ºå®šè§’åº¦æ¾æ‰‹ï¼Œæ³›åŒ–æ€§å·®
```

**æœŸæœ›è§„åˆ™ï¼š**
```python
# åŸºäºè§†è§‰åé¦ˆçš„è§„åˆ™ï¼ˆæ­£ç¡®ï¼‰
if vision.detect("ç‰©ä½“åœ¨ç›®æ ‡ä½ç½®"):
    gripper.open()  # åŸºäºè§†è§‰ç¡®è®¤ï¼Œæ³›åŒ–æ€§å¼º
```

**æ¨¡æ€ä¸¢å¼ƒå¦‚ä½•å¼ºåˆ¶å­¦ä¹ æ­£ç¡®è§„åˆ™ï¼š**

```
è®­ç»ƒæ—¶éšæœºåœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åœºæ™¯Aï¼ˆ70%æ¦‚ç‡ï¼‰: çŠ¶æ€å¯ç”¨          â”‚
â”‚   è¾“å…¥ï¼švision + state              â”‚
â”‚   æ¨¡å‹å¯ä»¥ç”¨ä¸¤ç§ä¿¡æ¯èåˆå†³ç­–         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åœºæ™¯Bï¼ˆ30%æ¦‚ç‡ï¼‰: çŠ¶æ€è¢«ç½®é›¶        â”‚
â”‚   è¾“å…¥ï¼švision + zeros              â”‚
â”‚   æ¨¡å‹å¿…é¡»åªç”¨è§†è§‰åšå†³ç­–            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®­ç»ƒåæ¨¡å‹è¡Œä¸ºï¼š
  Ï€*(action) â‰ˆ Ï€_vision(action) + Î»Â·Ï€_state(action)
  å…¶ä¸­Î»ä¼šè‡ªé€‚åº”é™ä½ï¼ˆå› ä¸ºçŠ¶æ€ä¸å¯é ï¼‰
```

**ç†è®ºåŸºç¡€ï¼š**
- Sensor Dropout (Pinto et al., 2016)
- Multimodal Learning with Dropout (Srivastava et al., 2014)

---

## ğŸ”¬ åç»­å·¥ä½œï¼ˆPhase 2 & 3ï¼‰

### Phase 2: æ³¨æ„åŠ›æ­£åˆ™åŒ–æŸå¤±

å¦‚æœæ¨¡æ€ä¸¢å¼ƒæ•ˆæœä¸å¤Ÿï¼Œå¯ä»¥å åŠ ï¼š

```bash
lerobot-train \
  --policy.use_modality_dropout=true \
  --policy.modality_dropout_prob=0.3 \
  --policy.use_attention_loss=true \  # æœªå®ç°ï¼Œéœ€è¦Phase 2
  --policy.attention_loss_weight=0.01
```

**é¢„æœŸå¢é‡æ•ˆæœï¼š**+5-10% æˆåŠŸç‡

---

### Phase 3: ç†µæœ€å¤§åŒ–

è¿›ä¸€æ­¥ä¼˜åŒ–è§†è§‰æ³¨æ„åŠ›åˆ†å¸ƒï¼š

```bash
lerobot-train \
  --policy.use_modality_dropout=true \
  --policy.use_attention_loss=true \
  --policy.use_entropy_loss=true  # æœªå®ç°ï¼Œéœ€è¦Phase 3
```

**é¢„æœŸå¢é‡æ•ˆæœï¼š**+2-5% æˆåŠŸç‡

---

## ğŸ“ è”ç³»ä¸åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ `test_modality_dropout_simple.py` çš„é™æ€æ£€æŸ¥ç»“æœ
2. æ£€æŸ¥è®­ç»ƒæ—¥å¿—ä¸­çš„lossæ›²çº¿
3. å¯¹æ¯”baselineå’Œdropoutçš„checkpoint

**ç¥è®­ç»ƒé¡ºåˆ©ï¼ğŸš€**

---

## ğŸ“ å˜æ›´æ—¥å¿—

### v1.0 - 2025-10-25

- âœ… æ·»åŠ  `use_modality_dropout` é…ç½®å‚æ•°
- âœ… æ·»åŠ  `modality_dropout_prob` é…ç½®å‚æ•°
- âœ… å®ç° `ACTPolicy.forward` ä¸­çš„æ¨¡æ€ä¸¢å¼ƒé€»è¾‘
- âœ… åŒ…å«é˜²å¾¡æ€§æ£€æŸ¥å’Œè¯¦ç»†æ–‡æ¡£
- âœ… ä¿è¯å‘åå…¼å®¹æ€§ï¼ˆé»˜è®¤å…³é—­ï¼‰
- âœ… é€šè¿‡æ‰€æœ‰é™æ€ä»£ç æ£€æŸ¥

### å¾…åŠ

- [ ] Phase 1: çŸ­è®­ç»ƒæµ‹è¯•ï¼ˆ100 stepsï¼‰
- [ ] Phase 2: å®Œæ•´è®­ç»ƒå¯¹æ¯”å®éªŒ
- [ ] Phase 3: æœºå™¨äººå®æµ‹
- [ ] Phase 4: å®ç°æ³¨æ„åŠ›æ­£åˆ™åŒ–æŸå¤±ï¼ˆå¦‚æœéœ€è¦ï¼‰
